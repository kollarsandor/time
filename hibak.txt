Ami most biztosan nem production ready (blokkoló hibák)

1) A build script rossz helyről keresi a forrásokat (path mismatch)

A scripts/build.sh a Terra és Futhark forrásokat a csrc/ alól keresi (${SRC_DIR}), miközben a repo-ban ezek src/terra/... és src/futhark/... alatt vannak. Emiatt a build alapból kihagyhatja az engine buildet és/vagy a Futhark részt.  ￼  ￼  ￼

2) A Docker builder image NEM telepít Terrát (és nagy eséllyel Futhark-ot sem)

A Dockerfile builder szakaszában nincs Terra telepítés (és Futhark sincs), miközben a build script ezeket feltételesen hívja. Így engine.so könnyen nem készül el, vagy “skip”-elődik.  ￼  ￼

3) A build “túl engedékeny”: hiba esetén továbbmegy

A script több helyen nem fail-fast módon viselkedik (pl. “Terra not found, skipping…”, “Futhark compile skipped…”), ami production-ben veszélyes: lehet olyan image, ami sikeresen buildel, de valójában nincs GPU-engine.  ￼

4) CPU stubok “sikerrel” térnek vissza → csendes hibás működés

A stub megoldás úgy van felépítve, hogy egy csomó cuBLAS / kernel call 0-val (sikerrel) tér vissza, de nem csinál semmit. Ez production-ben halál: ha véletlen a stub ágon fut, látszólag működik, csak rossz outputtal / null műveletekkel.  ￼

5) Runtime linker kockázat: engine.so + függő .so-k betöltése

A runtime image-ben az ENGINE_PATH=/app/build/engine.so, és a build is a build/ alá rakja a .so-kat. Viszont nincs explicit garancia (RPATH $ORIGIN vagy LD_LIBRARY_PATH a runtime stage-ben), hogy az engine.so mindig megtalálja a libcudawrap.so / libcublaswrap.so / libncclwrap.so / libkernels.so függőségeit. (A Terra oldalon sima névvel vannak linkelve.)  ￼  ￼

⸻

Következő prompt az agentnek (copy-paste)

Feladat: a jelenlegi repo-t ELSŐ PRÓBÁRA production ready állapotba hozni. NINCS kompromisszum: ugyanaz a modell, ugyanaz a runtime viselkedés és a 3000 tok/s cél érintetlen. Csak build/deploy/robosztusság javítás.

Környezeti feltételezés: a fájlok valódi helye a repo gyökérből indul (./), nem “bi/”.
Cél: egyetlen, konzisztens build pipeline, ami GPU-n engine.so-t és a szükséges .so-kat legyártja, és runtime-ban biztosan betölthető.

1) PATH KONZISZTENCIA (blokkoló)
- Javítsd a scripts/build.sh-ben a forrás-útvonalakat:
  - Terra forrás: ./src/terra/engine.t (ne ./csrc/terra/engine.t)
  - Futhark forrás: ./src/futhark/kernels.fut (ne ./csrc/futhark/kernels.fut)
  - A CUDA/C++ kód maradjon ./csrc/... alatt.
- A build végén az összes runtime-hoz szükséges .so kerüljön a ./build/ könyvtárba:
  - engine.so
  - libcudawrap.so, libcublaswrap.so, libncclwrap.so, libkernels.so
- A build.sh legyen fail-fast: ha engine.so nem készül el GPU build módban, EXIT 1.

2) DEPENDENCIÁK A DOCKER BUILDER-BEN (blokkoló)
- A Dockerfile builder stage-ben telepítsd Terrát (és ha kell, Futhark-ot).
  - Terra: pin-elt verzió, reproducible letöltés (pl. release tarball) + PATH.
  - Futhark: ha ténylegesen kell, pin-elt install; ha nem kell runtime-hoz, akkor tedd opcionálissá úgy, hogy a build ne “csendben” hagyja ki, hanem egyértelmű logot adjon.
- A Docker build akkor legyen sikeres, ha engine.so ténylegesen elkészült.

3) RUNTIME DYNAMIC LINKER GARANCIA (blokkoló)
- Biztosítsd, hogy az engine.so runtime-ban mindig megtalálja a build/ mappában lévő függő .so-kat:
  - Preferált: rpath=$ORIGIN beállítás az engine.so linkelésekor (Terra buildnél), hogy az engine.so a saját könyvtárából töltsön.
  - Alternatíva: runtime Dockerfile stage-ben állítsd be LD_LIBRARY_PATH=/app/build (de rpath az elsődleges).
- Adj hozzá egy minimál smoke tesztet a container indulásakor vagy CI-ben, ami:
  - betölti az engine.so-t
  - lefuttat egy trivialis initet és egy nagyon rövid generálást (akár 1 token) és ellenőrzi, hogy nem stub ág fut.

4) CPU STUBOK: PRODUCTION-BEN TILOS A “CSENDES SIKER”
- Alapértelmezett viselkedés: ha nincs NVCC/GPU, a build FAIL-eljen (EXIT 1).
- Ha kell fejlesztői mód, azt explicit flaggel engedd: ALLOW_CPU=1.
- A stub implementációk ne térjenek vissza “success=0”-val olyan hívásoknál, amik nélkül nincs korrekt működés (különösen cuBLAS/kernels). Inkább adjanak vissza egyértelmű hibakódot, amit a Terra oldal lekezel és leáll.

5) ACCEPTANCE CRITERIA (ne hagyd ki)
- docker build sikeres
- container indul és /healthz OK
- engine.so betöltődik (nincs “cannot open shared object file”)
- GPU build módban NINCS stub ág
- build logból egyértelmű, hogy Terra engine build lefutott
- a modell és a performancia cél NEM változik (kernel / modell logika érintetlen)

Output:
- Adj egy unified diff patch-et (vagy fájlonkénti módosítás-listát pontos kódrészletekkel), és egy rövid “how to run” részt (docker build/run parancsok).

